---
name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
      - name: Install build dependencies
        run: |
          dnf -y install \
            cmake \
            gcc-c++ \
            git \
            libdnf5-devel \
            snapper-devel \
            boost-devel \
            fmt-devel \
            catch2-devel \
            rpm-build \
            rpmdevtools \
            tar \
            gzip

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git safe directory
        run: git config --global --add safe.directory /__w/libdnf5-plugin-snapper/libdnf5-plugin-snapper

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

      - name: Verify version matches spec file
        run: |
          SPEC_VERSION=$(grep "^Version:" libdnf5-plugin-snapper.spec | awk '{print $2}')
          TAG_VERSION=${{ steps.version.outputs.VERSION }}
          if [ "${SPEC_VERSION}" != "${TAG_VERSION}" ]; then
            echo "ERROR: Spec version (${SPEC_VERSION}) does not match tag (${TAG_VERSION})"
            exit 1
          fi
          echo "✓ Version consistency verified"

      - name: Create source tarball
        id: tarball
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TARBALL="libdnf5-plugin-snapper-${VERSION}.tar.gz"

          # Create tarball from git archive (matches spec Source0)
          git archive --format=tar.gz \
            --prefix=libdnf5-plugin-snapper-${VERSION}/ \
            ${{ steps.version.outputs.TAG }} > ${TARBALL}

          echo "TARBALL=${TARBALL}" >> $GITHUB_OUTPUT
          echo "✓ Created source tarball: ${TARBALL}"

          # Calculate checksums
          sha256sum ${TARBALL} > ${TARBALL}.sha256
          md5sum ${TARBALL} > ${TARBALL}.md5

      - name: Build RPM and SRPM packages
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Setup rpmbuild tree
          rpmdev-setuptree

          # Copy spec and sources
          cp libdnf5-plugin-snapper.spec ~/rpmbuild/SPECS/
          cp libdnf5-plugin-snapper-${VERSION}.tar.gz ~/rpmbuild/SOURCES/

          # Build source RPM
          rpmbuild -bs ~/rpmbuild/SPECS/libdnf5-plugin-snapper.spec

          # Build binary RPM
          rpmbuild -bb ~/rpmbuild/SPECS/libdnf5-plugin-snapper.spec

          # Copy RPMs to workspace for easier access
          mkdir -p ./rpms ./srpms
          cp ~/rpmbuild/RPMS/x86_64/*.rpm ./rpms/
          cp ~/rpmbuild/SRPMS/*.rpm ./srpms/

          # List built packages
          echo "Built packages:"
          ls -lh ./rpms/
          ls -lh ./srpms/

      - name: Extract changelog for this release
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Extract changelog entry for this version from CHANGELOG.md
          # Between ## [VERSION] and next ## [ or end of file
          awk -v version="${VERSION}" '
            BEGIN { found=0; print_content=0 }
            /^## \[/ {
              if (found && print_content) exit
              if ($0 ~ "\\[" version "\\]") {
                found=1
                print_content=1
                next
              }
            }
            found && print_content && !/^## \[/ { print }
          ' CHANGELOG.md > release-notes.txt

          # Show what we extracted
          echo "Release notes:"
          cat release-notes.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}.tar.gz
            libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}.tar.gz.sha256
            libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}.tar.gz.md5
            rpms/*.rpm
            srpms/*.rpm
          body_path: release-notes.txt
          draft: false
          prerelease: false
          name: Release ${{ steps.version.outputs.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "✓ Release ${{ steps.version.outputs.TAG }} created successfully"
          echo ""
          echo "Artifacts:"
          echo "  - Source tarball: libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}.tar.gz"
          echo "  - Binary RPM: libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}-*.rpm"
          echo "  - Source RPM: libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}-*.src.rpm"
          echo "  - Checksums: SHA256 and MD5"