---
name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  # Job 1: Prepare source tarball, checksums, and changelog
  prepare:
    name: Prepare Release Assets
    runs-on: ubuntu-latest
    container:
      image: fedora:43

    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      tag: ${{ steps.version.outputs.TAG }}

    steps:
      - name: Install dependencies
        run: dnf -y install git tar gzip

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git safe directory
        run: git config --global --add safe.directory /__w/libdnf5-plugin-snapper/libdnf5-plugin-snapper

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

      - name: Verify version matches spec file
        run: |
          SPEC_VERSION=$(grep "^Version:" libdnf5-plugin-snapper.spec | awk '{print $2}')
          TAG_VERSION=${{ steps.version.outputs.VERSION }}
          if [ "${SPEC_VERSION}" != "${TAG_VERSION}" ]; then
            echo "ERROR: Spec version (${SPEC_VERSION}) does not match tag (${TAG_VERSION})"
            exit 1
          fi
          echo "Version consistency verified: ${SPEC_VERSION}"

      - name: Create source tarball
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TARBALL="libdnf5-plugin-snapper-${VERSION}.tar.gz"

          git archive --format=tar.gz \
            --prefix=libdnf5-plugin-snapper-${VERSION}/ \
            ${{ steps.version.outputs.TAG }} > ${TARBALL}

          echo "Created source tarball: ${TARBALL}"

          # Calculate checksums
          sha256sum ${TARBALL} > ${TARBALL}.sha256
          md5sum ${TARBALL} > ${TARBALL}.md5

      - name: Extract changelog for this release
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          awk -v version="${VERSION}" '
            BEGIN { found=0; print_content=0 }
            /^## \[/ {
              if (found && print_content) exit
              if ($0 ~ "\\[" version "\\]") {
                found=1
                print_content=1
                next
              }
            }
            found && print_content && !/^## \[/ { print }
          ' CHANGELOG.md > release-notes.txt

          echo "Release notes:"
          cat release-notes.txt

      - name: Upload source artifacts
        uses: actions/upload-artifact@v4
        with:
          name: source-tarball
          path: |
            libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}.tar.gz
            libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}.tar.gz.sha256
            libdnf5-plugin-snapper-${{ steps.version.outputs.VERSION }}.tar.gz.md5
            release-notes.txt
          retention-days: 1

  # Job 2: Build RPMs for each Fedora version
  build-rpms:
    name: Build RPMs for Fedora ${{ matrix.fedora_version }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        fedora_version: [42, 43]
    container:
      image: fedora:${{ matrix.fedora_version }}

    steps:
      - name: Install build dependencies
        run: |
          dnf -y install \
            cmake \
            gcc-c++ \
            git \
            libdnf5-devel \
            snapper-devel \
            boost-devel \
            fmt-devel \
            catch2-devel \
            rpm-build \
            rpmdevtools

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure git safe directory
        run: git config --global --add safe.directory /__w/libdnf5-plugin-snapper/libdnf5-plugin-snapper

      - name: Download source tarball
        uses: actions/download-artifact@v4
        with:
          name: source-tarball

      - name: Build RPM and SRPM packages
        run: |
          VERSION=${{ needs.prepare.outputs.version }}

          # Setup rpmbuild tree
          rpmdev-setuptree

          # Copy spec and sources
          cp libdnf5-plugin-snapper.spec ~/rpmbuild/SPECS/
          cp libdnf5-plugin-snapper-${VERSION}.tar.gz ~/rpmbuild/SOURCES/

          # Build both SRPM and binary RPM
          rpmbuild -ba ~/rpmbuild/SPECS/libdnf5-plugin-snapper.spec

          # List built packages
          echo "Built packages:"
          ls -lh ~/rpmbuild/RPMS/x86_64/
          ls -lh ~/rpmbuild/SRPMS/

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        with:
          name: rpms-fc${{ matrix.fedora_version }}
          path: ~/rpmbuild/RPMS/x86_64/libdnf5-plugin-snapper*.rpm
          retention-days: 1

      - name: Upload SRPM package
        uses: actions/upload-artifact@v4
        with:
          name: srpm-fc${{ matrix.fedora_version }}
          path: ~/rpmbuild/SRPMS/libdnf5-plugin-snapper*.src.rpm
          retention-days: 1

  # Job 3: Create GitHub Release with all artifacts
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-rpms]

    steps:
      - name: Download source tarball
        uses: actions/download-artifact@v4
        with:
          name: source-tarball
          path: artifacts/

      - name: Download FC42 RPMs
        uses: actions/download-artifact@v4
        with:
          name: rpms-fc42
          path: artifacts/

      - name: Download FC42 SRPM
        uses: actions/download-artifact@v4
        with:
          name: srpm-fc42
          path: artifacts/

      - name: Download FC43 RPMs
        uses: actions/download-artifact@v4
        with:
          name: rpms-fc43
          path: artifacts/

      - name: Download FC43 SRPM
        uses: actions/download-artifact@v4
        with:
          name: srpm-fc43
          path: artifacts/

      - name: List all artifacts
        run: |
          echo "Release artifacts:"
          ls -lh artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          body_path: artifacts/release-notes.txt
          draft: false
          prerelease: false
          name: Release ${{ needs.prepare.outputs.tag }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "Release ${{ needs.prepare.outputs.tag }} created successfully"
          echo ""
          echo "Artifacts:"
          ls -1 artifacts/
